var voices;

window.speechSynthesis.onvoiceschanged = function() {
    voices = window.speechSynthesis.getVoices();
};

Recispeak.recognizer = new webkitSpeechRecognition(); // create a new speech recognition object
Recispeak.recognizer.continuous = true;               // keeps the microphone open

// this will read aloud the step from the recipe array
Recispeak.readStep = function(step){ 
  var message = new SpeechSynthesisUtterance(step)
  message.voice = voices[2];
  speechSynthesis.speak(message); 
};

$(function(){
  setTimeout(function(){
    Recispeak.readStep("Let's get cookin! Click begin to start.");
  }, 500);

// These instructions are spoken aloud to the user so they know how to navigate through vocally
  $('#start-reading').click(function(){
    Recispeak.voice = voices[1];
    Recispeak.readStep("Please get everything ready. When you are comfortable, " +
                       "click to allow microphone access and then say the word " +
                       "'Next!' to hear the following step.");
    setTimeout(function(){
      Recispeak.recognizer.start();
    }, 3000);
  });
});

// Set the counter to 0 to iterate through the steps. Each if statement handles a different
// voice command. Next, Beginning, Repeat, and Back, will all navigate through the array of steps
// so the user can easily communicate what they need.

counter = 0;
Recispeak.recognizer.onresult = function(event) {
  for (var i = event.resultIndex; i < event.results.length; i++) {
    if ((event.results[i].isFinal) && (event.results[i][0].transcript == 'next')){
      setTimeout(function(){
        Recispeak.readStep(Recispeak.steps[counter]);
        counter += 1;
      }, 1000);
    } else {
      // console.log(event.results[i][0].transcript);
      // theResult = event.results[i][0].transcript.replace(" ","");
      if(counter < Recispeak.steps.length){
        if(event.results[i][0].transcript.replace(" ", "") == 'next'){
          setTimeout(function(){ 
            Recispeak.readStep(Recispeak.steps[counter]);
            counter += 1;
          }, 1000);
        } else if(event.results[i][0].transcript.replace(" ", "") == 'start'){
          setTimeout(function(){
            counter = 0;
            Recispeak.readStep(Recispeak.steps[counter]);
          }, 1000);
        } else if(event.results[i][0].transcript.replace(" ", "") == 'repeat'){
          setTimeout(function(){
            counter -= 1;
            Recispeak.readStep(Recispeak.steps[counter]);
            counter += 1;
          }, 1000);
        }
      } else {
        Recispeak.readStep("Your Recipe is Complete");
        counter = 0;
      }
    }
  }
};